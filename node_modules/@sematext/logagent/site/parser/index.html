<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Log Parser and pattern definitions - @sematext/logagent</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Log Parser and pattern definitions";
    var mkdocs_page_input_path = "parser.md";
    var mkdocs_page_url = "/parser/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> @sematext/logagent</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Features and Overview</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../installation/">Installation</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../windows/">Windows Installation</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../cli-parameters/">Usage</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../config-file/">Configuration file</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Log Parser and pattern definitions</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#how-does-the-parser-work">How does the parser work?</a></li>
                
            
                <li class="toctree-l3"><a href="#example">Example</a></li>
                
            
                <li class="toctree-l3"><a href="#nodejs-api-for-the-parser">Node.js API for the parser</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Plugins</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../plugins/">Overview</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Output plugins</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../output-elasticsearch/">Elasticsearch</a>
        
    </li>

        
    </ul>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Filter</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../filters/">About filters</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../input-filter-grep/">Grep input filter</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../output-filter-sql/">SQL output filter</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">@sematext/logagent</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Log Parser and pattern definitions</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/sematext/logagent-js" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="how-does-the-parser-work">How does the parser work?</h2>
<p>The parser detects log formats based on a pattern library (yaml file) and converts it to a JSON Object:</p>
<ul>
<li>find matching regex in pattern library</li>
<li>tag it with the recognized type</li>
<li>extract fields using regex</li>
<li>if 'autohash' is enabled, sensitive data is replaced with its sha1 hash code</li>
<li>parse dates and detect date format
  (use 'ts' field for date and time combined) </li>
<li>create ISO timestamp in '@timestamp' field</li>
<li>transform function to manipulate parsed objects</li>
<li>unmatched lines end up with timestamp and original line in the message field</li>
<li>JSON lines are parsed, and scanned for @timestamp and time fields (logstash and bunyan format)</li>
<li>default patterns for many applications (see below)</li>
<li>Heroku logs</li>
</ul>
<p>The default pattern definition file comes with patterns for:</p>
<ul>
<li>MongoDB</li>
<li>MySQL</li>
<li>Nginx</li>
<li>Redis</li>
<li>Elasticsearch</li>
<li>Webserver (nginx, apache httpd)</li>
<li>Zookeeper</li>
<li>Cassandra</li>
<li>Kafka</li>
<li>HBase HDFS Data Node</li>
<li>HBase Region Server</li>
<li>Hadoop YARN Node Manager</li>
<li>Apache Solr</li>
<li>various Linux/Mac OS X system log files</li>
</ul>
<p>The file format is based on <a href="https://nodeca.github.io/js-yaml/">JS-YAML</a>, in short:</p>
<pre><code>- - indicates an  array
- !js/regexp - indicates a JS regular expression
- !!js/function &gt; - indicates a JS function 
</code></pre>

<p>Properties:</p>
<ul>
<li>patterns: list of patterns, each pattern starts with "-"</li>
<li>match: group of patterns for a specific log source</li>
<li>regex: JS regular expression </li>
<li>fields: field list of extracted match groups from the regex</li>
<li>type: type used in Logsene (Elasticsearch Mapping)</li>
<li>dateFormat: format of the special fields 'ts', if the date format matches, a new field @timestamp is generated</li>
<li>transform: JS function to manipulate the result of regex and date parsing</li>
</ul>
<h1 id="example">Example</h1>
<pre><code># Sensitive data can be replaced with a hashcode (sha1)
# it applies to fields matching the field names by a regular expression
# Note: this function is not optimized (yet) and might take 10-15% of performance
autohash: !!js/regexp /user|password|email|credit_card_number|payment_info/i

# set this to false when autohash fields
# the original line might include sensitive data!
originalLine: false

# activate GeoIP lookup
geoIP: true

# logagent updates geoip db files automatically
# pls. note write access to this directory is required
maxmindDbDir: /tmp/

patterns: 
  - # APACHE  Web Logs
  sourceName: httpd
  match: 
    # Common Log Format
    - regex:        !!js/regexp /([0-9a-f.:]+)\s+(-|.+?)\s+(-|.+?)\s+\[([0-9]{2}\/[a-z]{3}\/[0-9]{4}\:[0-9]{2}:[0-9]{2}:[0-9]{2}[^\]]*)\] \&quot;(\S+?)\s(\S*?)\s{0,1}(\S+?)\&quot; ([0-9|\-]+) ([0-9|\-]+)/i
      type: apache_access_common
      fields:       [client_ip,remote_id,user,ts,method,path,http_version,status_code,size]
      dateFormat: DD/MMM/YYYY:HH:mm:ss ZZ
      # lookup geoip info for the field client_ip
      geoIP: client_ip
      # parse only messages that match this regex
      inputFilter: !!js/regexp /api|home|user/
      # ignore messages matching inputDrop
      inputDrop: !!js/regexp /127.0.0.1|\.css|\.js|\.png|\.jpg|\.jpeg/
      # modify parsed object
      transform: !!js/function &gt;
        function (p) {
          p.message = p.method + ' ' + p.path
        }
      customPropertyMinStatusCode: 399
      filter: !!js/function &gt; 
        function (p, pattern) {
          // log only requests with status code &gt; 399
          return p.status_code &gt; pattern.customPropertyMinStatusCode // 399
        }
</code></pre>

<p>The handling of JSON is different, regular expressions are not matched against JSON data. 
Logagent parse JSON and provides post processing functions in the pattern definition.
The following example masks fields in JSON and removes fields from the parsed event. </p>
<pre><code>hashFunction: sha512
# post process journald JSON format
# logagent feature to hash fields
# and a custom property 'removeFields', used in the transform function
json: 
  autohashFields: 
    - _HOSTNAME: true
  removeFields: 
    - _SOURCE_REALTIME_TIMESTAMP
    - __MONOTONIC_TIMESTAMP
  transform: !!js/function &gt;
   function (source, parsedObject, config) {
     for (var i=0; i&lt;config.removeFields.length; i++) {
       // console.log('delete ' +config.removeFields[i])
       delete parsedObject[config.removeFields[i]]
     }
   }
</code></pre>

<p>The default patterns are available <a href="https://github.com/sematext/logagent-js/blob/master/patterns.yml">here</a> - contributions are welcome!</p>
<h1 id="nodejs-api-for-the-parser">Node.js API for the parser</h1>
<p>Install logagent as local module and save the dependency to your package.json</p>
<pre><code>npm i logagent-js --save
</code></pre>

<p>Use the Logparser module in your source code</p>
<pre><code>var Logparser = require('logagent-js')
var lp = new Logparser('./patterns.yml')
lp.parseLine('log message', 'source name', function (err, data) {
    if(err) {
      console.log('line did not match any pattern')
    }
    console.log(JSON.stringify(data))
})
</code></pre>

<p>To test patterns or convert logs from text to JSON use the command line tool 'logagent'. It reads from stdin and outputs line delimited JSON (or pretty JSON or YAML) to the console. In addition, it can forward the parsed objects directly to <a href="http://sematext.com/logsene">Logsene</a> or Elasticsearch.</p>
<p>Test your patterns:</p>
<pre><code>cat myapp.log | bin/logagent -y -n myapp -f mypatterns.yml
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../plugins/" class="btn btn-neutral float-right" title="Overview">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../config-file/" class="btn btn-neutral" title="Configuration file"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/sematext/logagent-js" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../config-file/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../plugins/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
